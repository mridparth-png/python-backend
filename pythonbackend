from flask import Flask, request, jsonify
from flask_cors import CORS
import sqlite3, os, base64
import openai
import cv2
import numpy as np
from datetime import datetime

app = Flask(__name__)
CORS(app)

openai.api_key = os.getenv("OPENAI_API_KEY")

# ---------- DATABASE ----------
def db():
    return sqlite3.connect("data.db", check_same_thread=False)

def init_db():
    con = db()
    cur = con.cursor()

    cur.execute("""CREATE TABLE IF NOT EXISTS users(
        email TEXT PRIMARY KEY,
        password TEXT
    )""")

    cur.execute("""CREATE TABLE IF NOT EXISTS chats(
        email TEXT,
        message TEXT,
        reply TEXT,
        time TEXT
    )""")

    con.commit()

init_db()

# ---------- AUTH ----------
@app.route("/signup", methods=["POST"])
def signup():
    d = request.json
    try:
        con = db()
        cur = con.cursor()
        cur.execute("INSERT INTO users VALUES (?,?)",
                    (d["email"], d["password"]))
        con.commit()
        return jsonify(success=True)
    except:
        return jsonify(error="User exists"), 400

@app.route("/login", methods=["POST"])
def login():
    d = request.json
    cur = db().cursor()
    cur.execute("SELECT * FROM users WHERE email=? AND password=?",
                (d["email"], d["password"]))
    return jsonify(success=True) if cur.fetchone() else ("Unauthorized", 401)

# ---------- GPT CHAT ----------
@app.route("/chat", methods=["POST"])
def chat():
    d = request.json
    msg = d["message"]
    email = d.get("email", "guest")

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role":"system","content":"You are a calm mental health support assistant."},
            {"role":"user","content":msg}
        ]
    )

    reply = response.choices[0].message.content

    db().cursor().execute(
        "INSERT INTO chats VALUES (?,?,?,?)",
        (email, msg, reply, str(datetime.now()))
    )
    db().commit()

    return jsonify(reply=reply)

# ---------- CHAT HISTORY ----------
@app.route("/history", methods=["POST"])
def history():
    email = request.json["email"]
    cur = db().cursor()
    cur.execute("SELECT message, reply, time FROM chats WHERE email=?", (email,))
    return jsonify(cur.fetchall())

# ---------- MOOD DETECTION (CV) ----------
@app.route("/mood", methods=["POST"])
def mood():
    img_data = request.json["image"]
    img_bytes = base64.b64decode(img_data.split(',')[1])
    img_np = np.frombuffer(img_bytes, np.uint8)
    img = cv2.imdecode(img_np, cv2.IMREAD_COLOR)

    # Placeholder emotion detection
    mood = "Neutral"

    activities = {
        "Neutral": ["Breathing Exercise", "Calm Music"],
        "Sad": ["Motivational Video", "Guided Meditation"],
        "Stressed": ["Yoga", "Stress Relief Game"]
    }

    return jsonify(mood=mood, activities=activities[mood])

# ---------- START SERVER ----------
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
